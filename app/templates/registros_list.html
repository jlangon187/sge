{% extends "base.html" %}

{% block title %}Registros de Presencia{% endblock %}

{% block page_content %}
<div class="page-header">
    <h1><i class="fas fa-history"></i> Historial de Fichajes</h1>
</div>

<div class="well">
    <form class="form-inline" method="GET">
        <div class="form-group">
            <label><i class="fas fa-user"></i> Empleado:</label>
            <select name="empleado" class="form-control">
                <option value="">-- Todos --</option>
                {% for emp in empleados %}
                <option value="{{ emp.id_trabajador }}" {% if sel_empleado == emp.id_trabajador %}selected{% endif %}>
                    {{ emp.nombre }} {{ emp.apellidos }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-left: 10px;">
            <label><i class="far fa-calendar-alt"></i> Desde:</label>
            <input type="date" name="desde" class="form-control" value="{{ sel_desde }}">
        </div>
        <div class="form-group" style="margin-left: 10px;">
            <label>Hasta:</label>
            <input type="date" name="hasta" class="form-control" value="{{ sel_hasta }}">
        </div>
        <button type="submit" class="btn btn-primary" style="margin-left: 10px;">Filtrar</button>
        <a href="{{ url_for('empresas.ver_registros') }}" class="btn btn-default">Limpiar</a>
    </form>
</div>

<div class="panel panel-default">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Empleado</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Estado</th>
                <th>Duraci√≥n</th>
            </tr>
        </thead>
        <tbody>
            {% for reg in registros %}
            <tr>
                <td><strong>{{ reg.fecha.strftime('%d/%m/%Y') }}</strong></td>
                <td>{{ reg.trabajador.nombre }} {{ reg.trabajador.apellidos }}</td>
                <td class="text-success"><i class="fas fa-sign-in-alt"></i> {{ reg.hora_entrada.strftime('%H:%M') }}</td>
                <td>
                    {% if reg.hora_salida %}
                        <span class="text-danger"><i class="fas fa-sign-out-alt"></i> {{ reg.hora_salida.strftime('%H:%M') }}</span>
                    {% else %}
                        <span class="text-muted">--:--</span>
                    {% endif %}
                </td>
                <td>
                    {% if reg.hora_salida %}
                        <span class="label label-success">Completado</span>
                    {% else %}
                        <span class="label label-warning">En curso (Trabajando)</span>
                    {% endif %}
                </td>
                <td>
                    {% if reg.hora_salida %}
                        {% set duracion = (reg.hora_salida - reg.hora_entrada).total_seconds() / 3600 %}
                        {{ "%.2f"|format(duracion) }} h
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center text-muted">No se encontraron registros con estos filtros.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}